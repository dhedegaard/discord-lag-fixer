trigger:
- master

pool:
  vmImage: 'ubuntu-latest'

steps:

- task: Docker@2
  displayName: 'Build and push docker-image'
  inputs:
    containerRegistry: 'dockerhub'
    repository: 'dhedegaard/discord-lag-fixer'
    command: 'buildAndPush'
    Dockerfile: '**/Dockerfile'

- task: SSH@0
  displayName: 'Deploy new container'
  env:
    TOKEN: ${TOKEN}
    REGIONS_PREFIX: ${REGIONS_PREFIX}
  inputs:
    sshEndpoint: 'dennis@ymir'
    runOptions: 'inline'
    failOnStdErr: false
    inline: 'bash -e -x -c "
      cd discord-lag-fixer &&
      git pull -q --ff-only &&
      docker pull dhedegaard/discord-lag-fixer &&
      env TOKEN=${TOKEN} REGIONS_PREFIX=${REGIONS_PREFIX} docker stack deploy --prune -c docker-compose.yml discord-lag-fixer
    "'
